<!DOCTYPE html>
<html lang=" en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet-icon.png" rel="icon" type="image/png"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Subgraph API | Apache MXNet</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Subgraph API" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A flexible and efficient library for deep learning." />
<meta property="og:description" content="A flexible and efficient library for deep learning." />
<link rel="canonical" href="https://mxnet.apache.org/api/cpp/docs/tutorials/subgraph_api" />
<meta property="og:url" content="https://mxnet.apache.org/api/cpp/docs/tutorials/subgraph_api" />
<meta property="og:site_name" content="Apache MXNet" />
<script type="application/ld+json">
{"description":"A flexible and efficient library for deep learning.","headline":"Subgraph API","@type":"WebPage","url":"https://mxnet.apache.org/api/cpp/docs/tutorials/subgraph_api","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<script src="https://medium-widget.pixelpoint.io/widget.js"></script>
  <link rel="stylesheet" href="/versions/1.6/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://mxnet.apache.org/feed.xml" title="Apache MXNet" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96378503-1', 'auto');
  ga('send', 'pageview');
}
</script>
  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script src="/versions/1.6/assets/js/clipboard.js"></script>
  <script src="/versions/1.6/assets/js/copycode.js"></script>
  <style>
    .dropdown {
      position: relative;
      display: inline-block;
    }
  
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      padding: 12px 16px;
      z-index: 1;
      text-align: left;
    }
  
    .dropdown:hover .dropdown-content {
      display: block;
    }
  </style>
</head>
<body><header class="site-header" role="banner">

  <script>
    $(document).ready(function () {

      // HEADER OPACITY LOGIC

      function opacity_header() {
        var value = "rgba(4,140,204," + ($(window).scrollTop() / 300 + 0.4) + ")"
        $('.site-header').css("background-color", value)
      }

      $(window).scroll(function () {
        opacity_header()
      })
      opacity_header();

      // MENU SELECTOR LOGIC
      $('.page-link').each( function () {
        if (window.location.href.includes(this.href)) {
          $(this).addClass("page-current");
        }
      });
    })
  </script>
  <div class="wrapper">
    <a class="site-title" rel="author" href="/versions/1.6/"><img
            src="/versions/1.6/assets/img/mxnet_logo.png" class="site-header-logo"></a>
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger"/>
      <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
      </label>

      <div class="trigger">
        <a class="page-link" href="/versions/1.6/get_started">Get Started</a>
        <a class="page-link" href="/versions/1.6/blog">Blog</a>
        <a class="page-link" href="/versions/1.6/features">Features</a>
        <a class="page-link" href="/versions/1.6/ecosystem">Ecosystem</a>
        <a class="page-link" href="/versions/1.6/api">Docs & Tutorials</a>
        <a class="page-link" href="https://github.com/apache/incubator-mxnet">GitHub</a>
        <div class="dropdown">
          <span style="display:inline-flex;">1.6
            <svg viewBox="0 0 32 32" class="icon icon-caret-bottom" aria-hidden="true" style="width: 18px;"><path d="M24 11.305l-7.997 11.39L8 11.305z" style="fill: white;"></path></svg>
          </span>
          <div class="dropdown-content">
            <a href="/">master</a>
            <a style="color:#FF4500;" href="/versions/1.6/">1.6</a>
            <a href="/versions/1.5.0/">1.5.0</a>
            <a href="/versions/1.4.1/">1.4.1</a>
            <a href="/versions/1.3.1/">1.3.1</a>
            <a href="/versions/1.2.1/">1.2.1</a>
            <a href="/versions/1.1.0/">1.1.0</a>
            <a href="/versions/1.0.0/">1.0.0</a>
            <a href="/versions/0.12.1/">0.12.1</a>
            <a href="/versions/0.11.0/">0.11.0</a>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
    <script>

</script>
<article class="post">

    <header class="post-header wrapper">
        <h1 class="post-title">Subgraph API</h1>
        <h3></h3><a style="float:left; margin-top:20px" href="/versions/1.6/get_started" class="btn btn-action">Get Started
            <span class="span-accented">›</span></a></header>

    <div class="post-content">
        <div class="wrapper">
            <div class="row">
    <div class="col-3 docs-side-bar">

        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
        
        
        
        
        
        
        
        
        
        
        
        <div class="docs-card docs-side">
            <ul>
                <div class="docs-action-btn">
                    <a href="/versions/1.6/api/cpp"> <img src="/versions/1.6/assets/img/compass.svg"
                                                                      class="docs-logo-docs">C/C++ Guide <span
                            class="span-accented">›</span></a>
                </div>
                <div class="docs-action-btn">
                    <a href="/versions/1.6/api/cpp/docs/tutorials"> <img
                            src="/versions/1.6/assets/img/video-tutorial.svg" class="docs-logo-docs">C/C++
                        Tutorials <span class="span-accented">›</span></a>
                </div>
                <div class="docs-action-btn">
                    <a href="/versions/1.6/api/cpp/docs/api"> <img src="/versions/1.6/assets/img/api.svg"
                                                                    class="docs-logo-docs">C/C++ API Reference
                        <span class="span-accented">›</span></a>
                </div>

                <!-- Let's show the list of tutorials -->
                <br>
                
                <h3>Tutorials</h3>
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                
                <li><a href="/versions/1.6/api/cpp/docs/tutorials/basics">Basics</a></li>
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                
                <li><a href="/versions/1.6/api/cpp/docs/tutorials/cpp_inference">C++ API inference tutorial</a></li>
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                
                <li><a href="/versions/1.6/api/cpp/docs/tutorials/subgraph_api">Subgraph API</a></li>
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                
                  <!-- page-category -->
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                
                   <!-- resource-p -->
                  <!-- page -->
                
            </ul>
        </div>
        
        
        
        
        
        
        
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
        
           <!-- resource-p -->
          <!-- page -->
        </ul>
    </div>
    <div class="col-9">
        <!--- Licensed to the Apache Software Foundation (ASF) under one -->

<!--- or more contributor license agreements.  See the NOTICE file -->

<!--- distributed with this work for additional information -->

<!--- regarding copyright ownership.  The ASF licenses this file -->

<!--- to you under the Apache License, Version 2.0 (the -->

<!--- "License"); you may not use this file except in compliance -->

<!--- with the License.  You may obtain a copy of the License at -->

<!---   http://www.apache.org/licenses/LICENSE-2.0 -->

<!--- Unless required by applicable law or agreed to in writing, -->

<!--- software distributed under the License is distributed on an -->

<!--- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY -->

<!--- KIND, either express or implied.  See the License for the -->

<!--- specific language governing permissions and limitations -->

<!--- under the License. -->

<h2 id="subgraph-api">Subgraph API</h2>

<p>The subgraph API has been proposed and implemented as the default mechanism for integrating backend libraries to MXNet. The subgraph API is a very flexible interface. Although it was proposed as an integration mechanism, it has been used as a tool for manipulating NNVM graphs for graph-level optimizations, such as operator fusion.</p>

<p>The subgraph API works as the following steps:</p>

<ul>
<li>Search for particular patterns in a graph.</li>
<li>Group the operators/nodes with particular patterns into a subgraph and shrink the subgraph into a single node.</li>
<li>Replace the subgraph in the original graph with the subgraph node.</li>
</ul>

<p>The figure below illustrates the subgraph mechanism.</p>

<p><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/tutorials/subgraph/subgraph.png" alt=""></p>

<p>The subgraph API allows the backend developers to customize the subgraph mechanism in two places:</p>

<ul>
<li>Subgraph searching: define a subgraph selector to search for particular patterns in a computation graph.</li>
<li>Subgraph node creation: attach an operator to run the computation in the subgraph. We can potentially manipulate the subgraph here.</li>
</ul>

<p>The following is a demonstration of how the subgraph API can be applied to a simple task. Refer to the previous figure for an overview of the process. That is, replacing <code>Convolution</code> and <code>BatchNorm</code> with the conv_bn.</p>

<p>The first step is to define a subgraph selector to find the required pattern. To find a pattern that has <code>Convolution</code> and <code>BatchNorm</code>, we can start the search on the node with <code>Convolution</code>. Then from the <code>Convolution</code> node, we search for <code>BatchNorm</code> along the outgoing edge.</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="k">class</span> <span class="nc">SgSelector</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SubgraphSelector</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">SgSelector</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">find_bn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">Select</span><span class="p">(</span><span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// Here we start on the Convolution node to search for a subgraph.</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">.</span><span class="n">op</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">.</span><span class="n">op</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="s">"Convolution"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">SelectInput</span><span class="p">(</span><span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">&amp;</span><span class="n">new_node</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// We don't need to search on the incoming edge.</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">SelectOutput</span><span class="p">(</span><span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">&amp;</span><span class="n">new_node</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// We search on the outgoing edge. Once we find a BatchNorm node, we won't</span>
    <span class="c1">// accept any more BatchNorm nodes.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_node</span><span class="p">.</span><span class="n">op</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">new_node</span><span class="p">.</span><span class="n">op</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="s">"BatchNorm"</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">find_bn</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">find_bn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">*&gt;</span> <span class="n">Filter</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">candidates</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// We might have found a Convolution node, but we might have failed to find a BatchNorm</span>
    <span class="c1">// node that uses the output of the Convolution node. If we failed, we should skip</span>
    <span class="c1">// the Convolution node as well.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">find_bn</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">candidates</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span> <span class="o">*&gt;</span><span class="p">();</span>
  <span class="p">}</span>
 <span class="nl">private:</span>
  <span class="kt">bool</span> <span class="n">find_bn</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>The second step is to define a subgraph property to use the subgraph selector above to customize the subgraph searching. By defining this class, we can also customize subgraph node creation. When customizing node creation, we can specify what operator to run the subgraph on the node. In this example, we use <code>CachedOp</code>, which itself is a graph executor, to run the subgraph with <code>Convolution</code> and <code>BatchNorm</code>. In practice, it&#39;s most likely that we use a single operator from a backend library to replace the two operators for execution.</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="k">class</span> <span class="nc">SgProperty</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SubgraphProperty</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="k">static</span> <span class="n">SubgraphPropertyPtr</span> <span class="n">Create</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SgProperty</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">nnvm</span><span class="o">::</span><span class="n">NodePtr</span> <span class="n">CreateSubgraphNode</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Symbol</span> <span class="o">&amp;</span><span class="n">sym</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">subgraph_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// We can use CachedOp to execute the subgraph.</span>
    <span class="n">nnvm</span><span class="o">::</span><span class="n">NodePtr</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nnvm</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">Op</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="s">"_CachedOp"</span><span class="p">);</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ConvBN"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">subgraph_id</span><span class="p">);</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">subgraphs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">nnvm</span><span class="o">::</span><span class="n">Symbol</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sym</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">flags</span><span class="p">{{</span><span class="s">"static_alloc"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">}};</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">CachedOpPtr</span><span class="p">(</span><span class="k">new</span> <span class="n">CachedOp</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">flags</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">SubgraphSelectorPtr</span> <span class="n">CreateSubgraphSelector</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">property</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CreateSubgraphSelector</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">property</span><span class="o">-&gt;</span><span class="n">SetAttr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"property_name"</span><span class="p">,</span> <span class="s">"subgraph example pass"</span><span class="p">);</span> <span class="c1">// Optional, better to have it.</span>
    <span class="n">property</span><span class="o">-&gt;</span><span class="n">SetAttr</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"inference_only"</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">// Optional, only for inference_only pass.</span>
    <span class="k">return</span> <span class="n">property</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p><code>SetAttr</code> is optional and developer can define their own attributes to control property behavior.
There&#39;re some built-in attributes that used by MXNet executor.</p>

<p><code>property_name</code>  : std::string, name of this property, used for diagnose.</p>

<p><code>disable</code> : bool, whther to disable this property.</p>

<p><code>inference_only</code> : bool, apply this property only for inference. Property will be skiped when need_grad=True. Default <code>false</code> if this attribute isn&#39;t defined.</p>

<p>After defining the subgraph property, we need to register it under a backend in .cc file.</p>

<p>Firstly, we need to register the backend</p>
<div class="highlight"><pre><code class="language-C++" data-lang="C++">MXNET_REGISTER_SUBGRAPH_BACKEND(SgTest);
</code></pre></div>
<p>Then register the property under it.</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="n">MXNET_REGISTER_SUBGRAPH_PROPERTY</span><span class="p">(</span><span class="n">SgTest</span><span class="p">,</span> <span class="n">SgProperty</span><span class="p">);</span>
</code></pre></div>
<p>It&#39;s possible to register multiple properties for same backend. In practice, we recommend to put each property definition into .h file, and register backend in single .cc file. Property will be executed according to the register order.</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include "SgProperty.h" // Define SgProperty class
#include "SgProperty2.h" // Define SgProperty2 class
#include "SgProperty3.h" // Define SgProperty3 class
</span>
<span class="n">MXNET_REGISTER_SUBGRAPH_BACKEND</span><span class="p">(</span><span class="n">SgTest</span><span class="p">);</span>
<span class="n">MXNET_REGISTER_SUBGRAPH_PROPERTY</span><span class="p">(</span><span class="n">SgTest</span><span class="p">,</span> <span class="n">SgProperty</span><span class="p">);</span>  <span class="c1">// Execution order 1.</span>
<span class="n">MXNET_REGISTER_SUBGRAPH_PROPERTY</span><span class="p">(</span><span class="n">SgTest</span><span class="p">,</span> <span class="n">SgProperty2</span><span class="p">);</span> <span class="c1">// Execution order 2.</span>
<span class="n">MXNET_REGISTER_SUBGRAPH_PROPERTY</span><span class="p">(</span><span class="n">SgTest</span><span class="p">,</span> <span class="n">SgProperty3</span><span class="p">);</span> <span class="c1">// Execution order 3.</span>
</code></pre></div>
<p>After compiling this subgraph mechanism into MXNet, we can use the environment variable <code>MXNET_SUBGRAPH_BACKEND</code> to activate it during symbol bind.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">MXNET_SUBGRAPH_BACKEND</span><span class="o">=</span>SgTest
</code></pre></div>
<p>Or you can use python symbol API <code>get_backend_symbol</code> to run all properties registered for this backend and get returned symbol.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sym</span><span class="p">,</span> <span class="n">arg_params</span><span class="p">,</span> <span class="n">aux_params</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<span class="n">sym</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">get_backend_symbol</span><span class="p">(</span><span class="s">'SgTest'</span><span class="p">)</span>
</code></pre></div>
<p>When <code>SgProperty</code> is activated, a message will be shown in terminal as</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">start to execute subgraph example pass.
</code></pre></div>
<p>This tutorial shows a simple example of how to use the subgraph API to search for patterns in an NNVM graph.
Intested users can try different pattern matching rules (i.e., define their own <code>SubgraphSelector</code>) and
attach different operators to execute the subgraphs.</p>

<!-- INSERT SOURCE DOWNLOAD BUTTONS -->

    </div>
</div>

        </div>
    </div>

</article>

</main><footer class="site-footer h-card">
    <div class="wrapper">
        <div class="row">
            <div class="col-4">
                <h4 class="footer-category-title">Resources</h4>
                <ul class="contact-list">
                    <li><a href="/versions/1.6/community/contribute.html#mxnet-dev-communications">Mailing lists</a></li>
                    <li><a href="https://cwiki.apache.org/confluence/display/MXNET/Apache+MXNet+Home">Developer Wiki</a></li>
                    <li><a href="https://issues.apache.org/jira/projects/MXNET/issues">Jira Tracker</a></li>
                    <li><a href="https://github.com/apache/incubator-mxnet/labels/Roadmap">Github Roadmap</a></li>
                    <li><a href="https://discuss.mxnet.io">MXNet Discuss forum</a></li>
                    <li><a href="/versions/1.6/community/contribute.html">Contribute To MXNet</a></li>

                </ul>
            </div>

            <div class="col-4"><ul class="social-media-list"><li><a href="https://github.com/apache/incubator-mxnet"><svg class="svg-icon"><use xlink:href="/versions/1.6/assets/minima-social-icons.svg#github"></use></svg> <span class="username">apache/incubator-mxnet</span></a></li><li><a href="https://www.twitter.com/apachemxnet"><svg class="svg-icon"><use xlink:href="/versions/1.6/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">apachemxnet</span></a></li><li><a href="https://youtube.com/apachemxnet"><svg class="svg-icon"><use xlink:href="/versions/1.6/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">apachemxnet</span></a></li></ul>
</div>

            <div class="col-4 footer-text">
                <p>A flexible and efficient library for deep learning.</p>
            </div>
        </div>
    </div>
</footer>
<footer class="site-footer2">
    <div class="wrapper">
        <div class="row">
            <div class="col-3">
                <img src="/versions/1.6/assets/img/apache_incubator_logo.png" class="footer-logo col-2">
            </div>
            <div class="footer-bottom-warning col-9">
                <p>Apache MXNet is an effort undergoing incubation at The Apache Software Foundation (ASF), <span
                        style="font-weight:bold">sponsored by the <i>Apache Incubator</i></span>. Incubation is required
                    of all newly accepted projects until a further review indicates that the infrastructure,
                    communications, and decision making process have stabilized in a manner consistent with other
                    successful ASF projects. While incubation status is not necessarily a reflection of the completeness
                    or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
                </p><p>"Copyright © 2017-2018, The Apache Software Foundation Apache MXNet, MXNet, Apache, the Apache
                    feather, and the Apache MXNet project logo are either registered trademarks or trademarks of the
                    Apache Software Foundation."</p>
            </div>
        </div>
    </div>
</footer>




</body>

</html>
